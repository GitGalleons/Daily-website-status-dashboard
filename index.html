<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website Status Dashboard</title>
    <link href="style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

</head>
<body>
    <header class="bg-primary text-white py-3">
        <div class="container">
            <h1 class="h3 mb-0">Website Status Monitor</h1>
        </div>
    </header>

    <main class="container my-5">
        <section class="mb-5">
            <h2>Daily Website Status Report</h2>
            <p>Real-time monitoring and comprehensive status tracking for all websites</p>
            <p class="text-muted">Last updated: <span id="last-update">Loading last update time...</span></p>
        </section>

        <section class="row mb-5">
            <div class="col-md-3 mb-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-success">Sites Online</h5>
                        <h2 id="sites-online" class="display-4">0</h2>
                        <div class="progress mt-3" style="height: 5px;">
                            <div class="progress-bar bg-success" style="width: 100%;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-danger">Sites Down</h5>
                        <h2 id="sites-down" class="display-4">0</h2>
                        <div class="progress mt-3" style="height: 5px;">
                            <div class="progress-bar bg-danger" style="width: 100%;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-warning">Warnings</h5>
                        <h2 id="warnings" class="display-4">0</h2>
                        <div class="progress mt-3" style="height: 5px;">
                            <div class="progress-bar bg-warning" style="width: 100%;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-info">Total Sites</h5>
                        <h2 id="total-sites" class="display-4">0</h2>
                        <div class="progress mt-3" style="height: 5px;">
                            <div class="progress-bar bg-info" style="width: 100%;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="mb-5">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Status Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="status-chart" height="200"></canvas>
                </div>
            </div>
        </section>

        <section>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Detailed Status Report</h3>
                <div>
                    <button id="download-csv" class="btn btn-outline-primary me-2"> CSV</button>
                    <button id="download-json" class="btn btn-outline-primary me-2"> JSON</button>
                    <button id="print-report" class="btn btn-outline-primary"> Print</button>
                </div>
            </div>

            <div class="table-responsive">
                <table id="status-table" class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>URL</th>
                            <th>Status</th>
                            <th>HTTP Code</th>
                            <th>Last Checked (UTC)</th>
                            <th>Asia/Dhaka</th>
                            <th>Europe/London</th>
                            <th>America/New_York</th>
                            <th>Europe/Berlin</th>
                            <th>Asia/Shanghai</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be inserted here -->
                    </tbody>
                </table>
                <div id="loading-message">Loading...</div>
            </div>
        </section>
    </main>

    <footer class="bg-light py-3 text-center text-muted">
        <div class="container">
            Generated by GitHub Actions â€¢ Auto-refreshes every 5 minutes
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variable to hold the chart instance
        let statusChart = null;

        // Function to fetch and parse markdown table from reports/status.md
        async function loadStatusReport() {
            try {
                document.getElementById('loading-message').style.display = 'block';
                const response = await fetch('reports/status.md');
                if (!response.ok) throw new Error('Failed to load status.md');
                const mdText = await response.text();

                // Extract last updated
                const lastUpdatedLine = mdText.split('\n').find(line => line.startsWith('Last updated:'));
                if (lastUpdatedLine) {
                    const lastUpdated = lastUpdatedLine.replace('Last updated: ', '').trim();
                    document.getElementById('last-update').textContent = lastUpdated;
                }

                // Extract table from markdown
                const tableLines = mdText.split('\n').filter(line => line.trim().startsWith('|'));
                if (tableLines.length < 2) throw new Error('No table found in status.md');

                // Parse headers
                const headers = tableLines[0].split('|').map(h => h.trim()).filter(h => h);

                // Parse data rows (skip separator row)
                const dataRows = tableLines.slice(2).map(row => {
                    return row.split('|').map(c => c.trim()).filter(c => c);
                }).filter(row => row.length > 0);

                // Populate table
                const tbody = document.querySelector('#status-table tbody');
                tbody.innerHTML = '';
                dataRows.forEach(row => {
                    const tr = document.createElement('tr');
                    row.forEach((cell, idx) => {
                        const td = document.createElement(idx === 0 ? 'th' : 'td');
                        if (idx === 0) {
                            td.scope = 'row';
                            td.innerHTML = `<a href="${cell}" target="_blank" rel="noopener noreferrer">${cell}</a>`;
                        } else if (idx === 1) {
                            // Status with badge
                            const status = cell.toLowerCase();
                            let badgeClass = 'bg-secondary';
                            if (status.includes('ok') || parseInt(row[2]) < 300) badgeClass = 'bg-success';
                            else if (status.includes('error') || status.includes('not found') || status.includes('forbidden') || parseInt(row[2]) >= 400) badgeClass = 'bg-danger';
                            else badgeClass = 'bg-warning';
                            td.innerHTML = `<span class="badge ${badgeClass}">${cell}</span>`;
                        } else {
                            td.textContent = cell;
                        }
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });

                // Update stats
                let online = 0, down = 0, warnings = 0, total = dataRows.length;
                dataRows.forEach(row => {
                    const status = row[1].toLowerCase();
                    const code = parseInt(row[2]);
                    if (status.includes('ok') || code < 300) online++;
                    else if (code >= 400) down++;
                    else warnings++;
                });
                document.getElementById('sites-online').textContent = online;
                document.getElementById('sites-down').textContent = down;
                document.getElementById('warnings').textContent = warnings;
                document.getElementById('total-sites').textContent = total;

                // Update chart
                const ctx = document.getElementById('status-chart').getContext('2d');
                if (statusChart) statusChart.destroy();
                statusChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Online', 'Down', 'Warnings'],
                        datasets: [{
                            data: [online, down, warnings],
                            backgroundColor: ['rgba(16, 185, 129, 0.8)', 'rgba(239, 68, 68, 0.8)', 'rgba(245, 158, 11, 0.8)'],
                            borderWidth: 1,
                            borderColor: 'rgba(255,255,255,0.1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: true, text: 'Status Distribution' }
                        },
                        animation: { duration: 1500 }
                    }
                });

                document.getElementById('loading-message').style.display = 'none';
            } catch (err) {
                console.error('Error loading status report:', err);
                document.getElementById('loading-message').innerHTML = '<p class="text-danger">Failed to load status report. Please try refreshing the page.</p>';
            }
        }

        // Load report on page load
        window.addEventListener('load', loadStatusReport);

        // Auto-refresh every 5 minutes without full reload
        setInterval(loadStatusReport, 5 * 60 * 1000);

        // Download CSV
        document.getElementById('download-csv').addEventListener('click', () => {
            const table = document.getElementById('status-table');
            let csv = [];
            for (let row of table.rows) {
                let rowData = [];
                for (let cell of row.cells) {
                    rowData.push(cell.textContent.trim());
                }
                csv.push(rowData.join(','));
            }
            const csvContent = csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'website_status_report.csv';
            link.click();
            URL.revokeObjectURL(url);
        });

        // Download JSON
        document.getElementById('download-json').addEventListener('click', () => {
            const table = document.getElementById('status-table');
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            const data = rows.map(row => {
                const cells = Array.from(row.querySelectorAll('td, th')).map(td => td.textContent.trim());
                return headers.reduce((obj, h, i) => {
                    obj[h] = cells[i];
                    return obj;
                }, {});
            });
            const jsonContent = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'website_status_report.json';
            link.click();
            URL.revokeObjectURL(url);
        });

        // Print report
        document.getElementById('print-report').addEventListener('click', () => {
            window.print();
        });
    </script>
</body>
</html>