<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daily Website Status Report</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- DataTables CSS -->
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <style>
    /* Custom styles for the SL column */
    .sl-column {
      width: 50px;
      text-align: center;
    }
    /* Status icons styling */
    .status-icon {
      font-size: 1.2em;
      margin-right: 0.5rem;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="d-flex flex-column min-vh-100">
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="#">
        <i class="bi bi-clipboard-check me-2"></i>Website Status Dashboard
      </a>
      <div class="navbar-nav ms-auto">
        <a class="nav-link" href="https://github.com/GitGalleons/Daily-website-status-dashboard" target="_blank">
          <i class="bi bi-github me-1"></i>GitHub
        </a>
      </div>
    </div>
  </nav>

  <!-- Header Section -->
  <header class="bg-light py-4 mb-4">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1 class="display-5 fw-bold">Daily Website Status Report</h1>
          <p class="lead">Automated monitoring of website availability with multi-timezone support</p>
        </div>
        <div class="col-md-4 text-md-end">
          <div id="last-updated" class="text-muted" aria-live="polite"></div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mb-5 flex-grow-1">
    <div class="card shadow-sm">
      <div class="card-header bg-white py-3">
        <h5 class="card-title mb-0">
          <i class="bi bi-table me-2"></i>Status Overview
        </h5>
      </div>
      <div class="card-body p-0">
        <div id="report" class="report p-3">
          <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading latest report...</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-dark text-white py-4 mt-auto">
    <div class="container">
      <div class="row">
        <div class="col-md-6">
          <p class="mb-0">Generated by GitHub Actions • Monitoring <span id="site-count">0</span> websites</p>
        </div>
        <div class="col-md-6 text-md-end">
          <p class="mb-0">Dashboard reads <code>/reports/status.md</code></p>
        </div>
      </div>
    </div>
  </footer>

  <!-- Bootstrap & DataTables Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <script>
    // Try multiple paths so dashboard works both for project pages and user/org pages.
    async function tryFetchPaths(paths) {
      for (const p of paths) {
        try {
          const resp = await fetch(p, { cache: 'no-store' });
          if (resp.ok) return await resp.text();
          // 404 or other non-ok — continue to next candidate
        } catch (err) {
          // network error, continue to next
        }
      }
      throw new Error('all fetch attempts failed');
    }

    function makeRawGuess() {
      // Try to guess owner/repo from the current URL to present a helpful raw link
      const host = window.location.hostname; // e.g., gitgalleons.github.io
      let owner = host.split('.')[0] || '';
      const segments = window.location.pathname.split('/').filter(Boolean);
      const repo = segments[0] || '';
      if (owner && repo) {
        return `https://raw.githubusercontent.com/${owner}/${repo}/main/reports/status.md`;
      }
      return null;
    }

    function initializeDataTable() {
      $('#status-table').DataTable({
        responsive: true,
        ordering: true,
        order: [[1, 'asc']], // Order by website name (2nd column) by default
        pageLength: 25,
        lengthMenu: [10, 25, 50, 100],
        dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip',
        language: {
          search: "Filter:",
          lengthMenu: "Show _MENU_ entries"
        },
        columnDefs: [
          { orderable: false, targets: 0 } // Make SL column not orderable
        ]
      });
    }

    // Function to add SL column to the table
    function addSerialNumberColumn() {
      const table = document.getElementById('status-table');
      if (!table) return;
      
      // Add SL header
      const headerRow = table.querySelector('thead tr');
      if (headerRow) {
        const slHeader = document.createElement('th');
        slHeader.className = 'sl-column';
        slHeader.textContent = 'SL';
        headerRow.insertBefore(slHeader, headerRow.firstChild);
      }
      
      // Add serial numbers to each row
      const rows = table.querySelectorAll('tbody tr');
      rows.forEach((row, index) => {
        const slCell = document.createElement('td');
        slCell.className = 'sl-column';
        slCell.textContent = index + 1;
        row.insertBefore(slCell, row.firstChild);
      });
    }

    async function loadReport() {
      const reportEl = document.getElementById('report');
      const lastEl = document.getElementById('last-updated');
      const siteCountEl = document.getElementById('site-count');

      // Candidate paths (order matters)
      const candidates = [
        'reports/status.md',       // relative — works for project pages (recommended)
        '/reports/status.md',      // absolute path — works for user/org site served from root
      ];

      try {
        const md = await tryFetchPaths(candidates);
        // Extract last-updated line for header
        const match = md.match(/Last updated:\s*(.+)/i);
        if (match && match[1]) lastEl.textContent = 'Last updated: ' + match[1].trim();
        else lastEl.textContent = '';

        reportEl.innerHTML = marked.parse(md);

        // Count sites and update footer
        var table1 = reportEl.querySelector('table');
        if (table1) {
          const rowCount = table1.querySelectorAll('tbody tr').length;
          siteCountEl.textContent = rowCount;
        }

        // Color rows by HTTP code and add icons
        document.querySelectorAll('table tbody tr').forEach(row => {
          const codeCell = row.cells[2]; // HTTP Code column is 3rd column
          const statusCell = row.cells[1]; // Status column
          if (!codeCell) return;
          
          const codeText = codeCell.textContent.trim();
          const code = parseInt(codeText, 10);
          
          // Add status icon
          const icon = document.createElement('i');
          icon.className = 'bi status-icon';
          
          if (!Number.isFinite(code) || /ERR|ERROR|Timeout/i.test(codeText)) {
            row.classList.add('table-danger');
            icon.className += ' bi-x-circle-fill text-danger';
            statusCell.innerHTML = icon.outerHTML + statusCell.innerHTML;
          } else if (code >= 200 && code < 300) {
            row.classList.add('table-success');
            icon.className += ' bi-check-circle-fill text-success';
            statusCell.innerHTML = icon.outerHTML + statusCell.innerHTML;
          } else if (code >= 300 && code < 400) {
            row.classList.add('table-warning');
            icon.className += ' bi-arrow-right-circle-fill text-warning';
            statusCell.innerHTML = icon.outerHTML + statusCell.innerHTML;
          } else {
            row.classList.add('table-danger');
            icon.className += ' bi-exclamation-circle-fill text-danger';
            statusCell.innerHTML = icon.outerHTML + statusCell.innerHTML;
          }
        });

        // Initialize DataTable
        if ($.fn.DataTable.isDataTable('#status-table')) {
          $('#status-table').DataTable().destroy();
        }
        
        // Add ID to table for DataTables initialization
        var table2 = reportEl.querySelector('table');
        if (table2) {
          table2.id = 'status-table';
          
          // Add the SL column before initializing DataTable
          addSerialNumberColumn();
          
          initializeDataTable();
        }

      } catch (err) {
        // All attempts failed — show helpful diagnostics and a link to the raw file if guessable
        const rawLink = makeRawGuess();
        let html = `<div class="alert alert-danger" role="alert">
          <h4 class="alert-heading">Could not load report</h4>
          <p>${err.message}. The dashboard now tries a relative path (recommended for project pages) and an absolute path.</p>`;
        
        if (rawLink) {
          html += `<p>If the file exists in the repository you can open the raw report directly: <a href="${rawLink}" target="_blank" rel="noopener">${rawLink}</a></p>`;
        } else {
          html += `<p>Please confirm the file <code>reports/status.md</code> exists on the branch GitHub Pages publishes (usually <code>main</code>), and that Pages is configured to serve from that branch/folder.</p>`;
        }
        
        html += `</div>`;
        reportEl.innerHTML = html;
        lastEl.textContent = '';
      }
    }

    // Load report on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadReport();
      setInterval(loadReport, 5 * 60 * 1000); // Refresh every 5 minutes
    });
  </script>
</body>
</html>